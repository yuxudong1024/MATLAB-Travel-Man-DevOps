variables:
  IMAGE_TAG: "1.0"
  DOCKER_IMAGE: "registry.insidelabs-git.mathworks.com/cbollige/matlab-devops-registry/matlab-devops-r2024b"

stages:
  - deploy
  - publish

matlab-build:
  stage: deploy
  tags:
    - on-prem
    #- docker-exec
  #image: 
  #  name: $DOCKER_IMAGE:$IMAGE_TAG
  script:
    - echo "Running unit tests..."
    - mw -using BR2024bd matlab -softwareopengl -batch "buildtool check test -verbosity Verbose"
    - echo "Deploying web app..."   
    - mw -using BR2024bd matlab -softwareopengl -batch "buildtool deployWebApp('TEST') -verbosity Verbose"
    - echo "Deploying production server archive and html frontend..."
    - mw -using BR2024bd matlab -softwareopengl -batch "mpsArchiveName=['shortestTrip',upper(getenv('GITLAB_USER_LOGIN'))]; disp(mpsArchiveName); buildtool deployMPSArchive(mpsArchiveName) deployFrontend integrationTest -verbosity Verbose"
  coverage: '/Statement: \d+/\d+ \((\d+\.\d+)%\)/'
  artifacts:
    when: always
    paths:
      - public
    reports:
      junit: public/test-reports/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: public/code-coverage/cobertura-coverage.xml

#visdiff:
#  stage: deploy
#  tags:
#    - docker-exec
#  image: 
#    name: $DOCKER_IMAGE:$IMAGE_TAG
#  script:
#    - echo "Comparing current version of MATLAB app to status in main branch..."
#    - git config --global --add safe.directory $CI_PROJECT_DIR
#    - matlab-batch "buildtool publishAppDiffToMain('visdiff') -verbosity Verbose"
#    - echo "Report published as artifact in visdiff folder"
#  dependencies: [] # Prevent downloading of artifacts from previous jobs
#  artifacts:
#    paths:
#      - visdiff/*
#  except:
#    - main


pages:
  stage: publish
  tags:
    - linux
  script:
    - echo "Creating Gitlab pages"
  artifacts:
    paths:
      - public